#!/bin/bash

## RetroNAS autogenerated
## Called by /etc/cron.d/service_3ds_qr_codes

MYURL="http://192.168.3.200/3ds"
umask 002

generate_qr () {
# Build path
mkdir -p "${QRDIR}" 2>/dev/null
# Convert URLs to HTML safe encoding:
CIAURL=$( echo "${MYURL}/cia/$RELDIR/${BASENAME}" | sed 's/\ /%20/g' )
QRURL=$( echo "${MYURL}/qr/$RELDIR/${BARENAME}.png" | sed 's/\ /%20/g' )
# Generate QR code
qrencode -o "${QRDIR}/${BARENAME}.png" -s 10 "${CIAURL}"
# Generate HTML file
echo "\
<html>\
<center>\
<br><br>\
"${CIAURL}"\
<br><br>\
<img src="${QRURL}" border="0">\
<br><br>" > "${QRDIR}/${BARENAME}".html
}


## Find CIA files to scan
find "/data/retronas/3ds/cia" -type f -iname '*.cia' | while read CIAFILE
do
  BASENAME=$( basename "${CIAFILE}" )
  BARENAME="${BASENAME%.*}"
  BASEDIR=$( dirname "${CIAFILE}" )
  RELDIR=$( echo "${BASEDIR}" | sed 's#/data/retronas/3ds/cia##g' )
  QRDIR="/data/retronas/3ds/qr/${RELDIR}"
  test -f "${QRDIR}/${BARENAME}".png || generate_qr
done
